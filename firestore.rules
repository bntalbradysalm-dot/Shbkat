
/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model. All user-
 * related data, including profiles, transactions, and favorites, is private. A user
 * can only access and manage their own data; they have no visibility into the data
 * of other users.
 *
 * Data Structure: The data is organized hierarchically. All user-specific information,
 * such as transactions and favorites, is stored in subcollections directly under that
 * user's document at `/users/{userId}`. This structure is fundamental to the
 * security model, as it allows rules to leverage the document path for authorization.
 *
 * Key Security Decisions:
 * - User Isolation: Users are strictly isolated from one another. A user can only
 *   ever interact with documents within their own data tree (i.e., `/users/{their_own_uid}/...`).
 * - No User Enumeration: Listing the top-level `/users` collection is explicitly
 *   disallowed to prevent any user from discovering the existence of other users.
 * - Ownership by Path: Authorization is determined by matching the `userId` in the
 *   path with the authenticated user's UID (`request.auth.uid`). This is efficient
 *   and avoids costly database reads (`get()` calls) within the rules.
 * - Prototyping Flexibility: While authorization is strict, data validation is
 *   minimal. The rules only validate fields critical for establishing ownership and
 *   maintaining relational integrity (e.g., ensuring a new transaction's `userId` field
 *   matches the user creating it). All other data fields can be changed freely to
 *   support rapid development.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return request.auth.token.email == '770326828@shabakat.com';
    }
    
    function isNetworkOwner(networkId) {
      return isSignedIn() && get(/databases/$(database)/documents/networks/$(networkId)).data.ownerId == request.auth.uid;
    }


    /**
     * Checks if the currently signed-in user's UID matches the provided userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for update and delete
     * operations to prevent acting on non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * On create, validates that the incoming document's ID field matches the
     * user's UID from the path, ensuring data integrity.
     */
    function incomingDataMatchesUserId(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * On create, validates that the incoming document's 'userId' field matches
     * the user's UID from the path, ensuring relational integrity for subcollections.
     */
    function incomingSubcollectionDataMatchesUser(userId) {
      return request.resource.data.userId == userId;
    }
    
    /**
     * On create, validates that the incoming RenewalRequest's 'userId' field matches
     * the authenticated user's UID.
     */
    function isRequestOwner() {
        return request.resource.data.userId == request.auth.uid;
    }
    
     /**
     * On create, validates that the incoming TransferRequest's 'fromUserId' field matches
     * the authenticated user's UID.
     */
    function isTransferRequestOwner() {
        return request.resource.data.fromUserId == request.auth.uid;
    }
    
    function isBuyer() {
      return request.resource.data.buyerId == request.auth.uid;
    }
    
    function isWithdrawalRequestOwner() {
      return request.resource.data.ownerId == request.auth.uid;
    }


    /**
     * On update, ensures the 'id' field of a user document cannot be changed.
     */
    function isUserIdImmutable() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * On update, ensures the 'userId' foreign key field cannot be changed.
     */
    function isUserForeignKeyImmutable() {
      return request.resource.data.userId == resource.data.userId;
    }
    
     /**
     * Validates that an update operation is only incrementing the balance field
     * and not touching any other fields. This is used for direct user-to-user transfers
     * or automated payouts.
     */
    function isBalanceUpdate() {
        let otherFields = request.resource.data.diff(resource.data).affectedKeys();
        return otherFields.hasOnly(['balance']);
    }


    // -------------------------------------------------------------------------
    // Collection Rules
    // -------------------------------------------------------------------------
    
     /**
     * @description Manages Al-Wadi renewal options. Anyone can read, but only
     * admins can write (create, update, delete).
     * @path /alwadiOptions/{optionId}
     * @allow Any signed-in user can read the list of renewal options. (list, get)
     * @allow An admin user can create a new renewal option. (create)
     * @allow An admin user can update an existing renewal option. (update)
     * @allow An admin user can delete a renewal option. (delete)
     * @deny A non-admin user tries to create, update, or delete an option.
     * @principle Separates read access (for all) from write access (for admins).
     */
    match /alwadiOptions/{optionId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    /**
     * @description Manages the promotional advertisement. Anyone can read, but
     * only admins can write (create, update, delete).
     * @path /advertisements/{adId}
     * @allow Any signed-in user can read the ad. (list, get)
     * @allow An admin user can create, update, or delete the ad. (write)
     * @deny A non-admin user tries to create, update, or delete an ad.
     * @principle Centralized ad management, admin-controlled.
     */
    match /advertisements/{adId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    /**
     * @description Manages global notifications. Anyone can read, but only
     * admins can write (create). Updates and deletes are disallowed for all.
     * @path /notifications/{notificationId}
     * @allow Any signed-in user can read the list of notifications. (list, get)
     * @allow An admin user can create a new notification. (create)
     * @allow An admin user can delete a notification. (delete)
     * @deny Any user tries to update a notification.
     * @principle Centralized announcements, immutable after creation.
     */
    match /notifications/{notificationId} {
        allow read: if isSignedIn();
        allow create, delete: if isAdmin();
        allow update: if false; // Notifications are immutable
    }
    
    /**
     * @description Manages subscription renewal requests. Authenticated users can
     * create their own requests. Admins can read all requests and update their status.
     * @path /renewalRequests/{requestId}
     * @allow A signed-in user creates a renewal request for themselves. (create)
     * @allow An admin user reads all renewal requests. (list, get)
     * @allow An admin user updates the status of a request. (update)
     * @deny A non-admin user tries to read or modify requests that are not their own.
     * @principle Users manage their own requests; admins manage the queue.
     */
    match /renewalRequests/{requestId} {
      allow create: if isSignedIn() && isRequestOwner();
      allow read, update, delete: if isAdmin();
    }

    /**
     * @description Manages withdrawal requests from network owners.
     * @path /withdrawalRequests/{requestId}
     */
    match /withdrawalRequests/{requestId} {
      allow create: if isSignedIn() && isWithdrawalRequestOwner();
      allow read, update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    /**
     * @description Manages user requests to transfer funds. This collection is no longer
     * used for creating new requests but is kept for archival purposes. Only admins
     * can manage old requests.
     * @path /transferRequests/{requestId}
     * @allow An admin user can read, update or delete old requests.
     * @deny Users can no longer create new transfer requests.
     */
    match /transferRequests/{requestId} {
      allow create: if false; // Disabled in favor of direct transfers
      allow read, update, delete: if isAdmin();
    }
    
    /**
     * @description Manages available payment methods. Any authenticated user can read
     * them (including server-side functions), but only admins can modify them.
     * @path /paymentMethods/{methodId}
     * @allow Any signed-in user or server process can read the list of payment methods. (list, get)
     * @allow An admin user can create, update, or delete payment methods. (create, update, delete)
     * @deny A non-admin user tries to modify payment methods.
     * @principle Centralized payment configuration, admin-controlled, server-readable.
     */
    match /paymentMethods/{methodId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Allow AI flow to list payment methods
    match /paymentMethods {
      allow list: if isSignedIn();
    }
    
    /**
     * @description Manages the list of Al-Wadi subscribers, keyed by their card number.
     * Used for auto-filling subscriber names during renewal.
     * @path /subscribers/{subscriberId}
     * @allow Any signed-in user can read a subscriber's data. (get)
     * @allow Any signed-in user can list all subscribers. (list)
     * @allow An admin user can create, update, or delete subscribers. (write)
     * @deny Non-admin users cannot modify the subscriber list.
     */
    match /subscribers/{subscriberId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }
    
    /**
     * @description Manages global application settings.
     * @path /appSettings/{settingsId}
     * @allow Any user (authenticated or not) can read the application settings.
     * @allow Admins can modify the application settings.
     * @deny Non-admin users cannot write settings.
     */
    match /appSettings/{settingsId} {
        allow read: if true;
        allow write: if isAdmin();
    }
    
    /**
     * @description Stores records of sold cards for reporting.
     */
    match /soldCards/{cardId} {
      // Users can create a record when they buy a card.
      allow create: if isSignedIn() && isBuyer();
      // Admins and the buyer can read individual sold card records.
      allow get: if isAdmin() || isBuyer();
      // Nobody can update or delete records directly.
      allow update, delete: if false;
    }
    
    // Admins can list all sold cards for reporting.
    match /soldCards {
        allow list: if isAdmin();
    }
    
    /**
     * @description Stores records of automated deposits to prevent duplicates.
     * @path /depositRequests/{requestId}
     * @allow Server-side logic (AI flow) and signed in users can create and read deposit requests.
     */
    match /depositRequests/{requestId} {
      allow write: if isSignedIn();
      allow read: if isSignedIn();
    }


    /**
     * @description Manages user profile documents. Only the owner can read, update,
     * or delete their own profile. A user can create their own profile. Listing
     * all users is forbidden.
     * @path /users/{userId}
     * @allow A signed-in user (uid: 'user123') reads their own document at `/users/user123`. (get)
     * @allow A new user (uid: 'user456') creates their profile document at `/users/user456`. (create)
     * @allow A signed-in user can update another user's balance via a transaction (validated increment).
     * @deny An authenticated user (uid: 'user123') tries to read another user's profile at `/users/userABC`. (get)
     * @deny Any user attempts to list all documents in the `/users` collection. (list)
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) && incomingDataMatchesUserId(userId);
      // Allow any signed-in party (like a server function for deposits or another user for transfers) to update.
      allow update: if isSignedIn();
      allow delete: if isAdmin();

      /**
       * @description Manages a user's private transaction history. Access is restricted
       * to the user who owns the parent user document.
       * @path /users/{userId}/transactions/{transactionId}
       * @allow A signed-in user (uid: 'user123') lists their own transactions at `/users/user123/transactions`. (list)
       * @allow A signed-in user (uid: 'user123') creates a new transaction under their own path. (create)
       * @deny An authenticated user (uid: 'user123') tries to read a transaction at `/users/userABC/transactions/tx_1`. (get)
       * @deny An authenticated user (uid: 'user123') tries to create a transaction under another user's path. (create)
       * @principle Enforces inherited ownership from parent document path for all operations.
       */
      match /transactions/{transactionId} {
        allow read: if isOwner(userId);
        allow create: if isSignedIn();
        allow update: if isExistingOwner(userId) && isUserForeignKeyImmutable();
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Manages a user's private list of favorites. Access is restricted
       * to the user who owns the parent user document.
       * @path /users/{userId}/favorites/{favoriteId}
       * @allow A signed-in user (uid: 'user123') lists their own favorites at `/users/user123/favorites`. (list)
       * @allow A signed-in user (uid: 'user123') creates a new favorite under their own path. (create)
       * @deny An authenticated user (uid: 'user123') tries to read a favorite at `/users/userABC/favorites/fav_1`. (get)
       * @deny An authenticated user (uid: 'user123') tries to create a favorite under another user's path. (create)
       * @principle Enforces inherited ownership from parent document path for all operations.
       */
      match /favorites/{favoriteId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && incomingSubcollectionDataMatchesUser(userId);
        allow update: if isExistingOwner(userId) && isUserForeignKeyImmutable();
        allow delete: if isExistingOwner(userId);
      }
      
      /**
       * @description Manages personal notifications for a user.
       * @path /users/{userId}/notifications/{notificationId}
       * @allow The user can read their own notifications. (read)
       * @allow Admins can create notifications for the user. (create)
       * @allow The user can delete their own notifications. (delete)
       * @deny Users cannot update notifications.
       * @principle User-owned readable/deletable data, admin-writable.
       */
      match /notifications/{notificationId} {
          allow read: if isOwner(userId);
          allow create: if isAdmin() || isSignedIn(); // Allow any signed-in user for transaction notifications
          allow delete: if isOwner(userId); // Allow user to delete their own notifications
          allow update: if false;
      }
    }
    
    /**
     * @description Manages WiFi network information.
     * @path /networks/{networkId}
     * @allow Any signed-in user can read network information.
     * @allow Admins can create, update, or delete networks.
     * @allow The owner of the network can update it.
     */
    match /networks/{networkId} {
      allow read: if isSignedIn();
      allow create: if isAdmin() || request.resource.data.ownerId == request.auth.uid;
      allow update: if isAdmin() || isNetworkOwner(networkId);
      allow delete: if isAdmin() || isNetworkOwner(networkId);

      /**
       * @description Manages card categories for a network.
       * @path /networks/{networkId}/cardCategories/{categoryId}
       * @allow Any signed-in user can read card categories.
       * @allow Admins or the network owner can write categories.
       */
      match /cardCategories/{categoryId} {
        allow read: if isSignedIn() || isAdmin();
        allow write: if isAdmin() || isNetworkOwner(networkId);
      }

      /**
       * @description Manages individual WiFi cards.
       * @path /networks/{networkId}/cards/{cardId}
       * @allow Admins or network owner can manage cards.
       * @allow Signed-in users can read available cards.
       * @allow A signed-in user can purchase an available card (update status to 'sold').
       */
      match /cards/{cardId} {
        allow read: if isSignedIn() || isAdmin();
        allow create, delete: if isAdmin() || isNetworkOwner(networkId);
        // Allow admin/owner to update any field.
        // Allow user to update only to purchase (set status to 'sold' and add their UID).
        allow update: if (isAdmin() || isNetworkOwner(networkId)) || (isSignedIn() 
            && request.resource.data.status == 'sold'
            && resource.data.status == 'available'
            && request.resource.data.soldTo == request.auth.uid);
      }
    }
  }
}
    

    

    