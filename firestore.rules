
/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model. All user-
 * related data, including profiles, transactions, and favorites, is private. A user
 * can only access and manage their own data; they have no visibility into the data
 * of other users.
 *
 * Data Structure: The data is organized hierarchically. All user-specific information,
 * such as transactions and favorites, is stored in subcollections directly under that
 * user's document at `/users/{userId}`. This structure is fundamental to the
 * security model, as it allows rules to leverage the document path for authorization.
 *
 * Key Security Decisions:
 * - User Isolation: Users are strictly isolated from one another. A user can only
 *   ever interact with documents within their own data tree (i.e., `/users/{their_own_uid}/...`).
 * - No User Enumeration: Listing the top-level `/users` collection is explicitly
 *   disallowed to prevent any user from discovering the existence of other users.
 * - Ownership by Path: Authorization is determined by matching the `userId` in the
 *   path with the authenticated user's UID (`request.auth.uid`). This is efficient
 *   and avoids costly database reads (`get()` calls) within the rules.
 * - Prototyping Flexibility: While authorization is strict, data validation is
 *   minimal. The rules only validate fields critical for establishing ownership and
 *   maintaining relational integrity (e.g., ensuring a new transaction's `userId` field
 *   matches the user creating it). All other data fields can be changed freely to
 *   support rapid development.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return request.auth.token.email == '770326828@shabakat.com';
    }
    
    function isNetworkOwner(networkId) {
      return isSignedIn() && get(/databases/$(database)/documents/networks/$(networkId)).data.ownerId == request.auth.uid;
    }


    /**
     * Checks if the currently signed-in user's UID matches the provided userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * On create, validates that the incoming document's 'userId' field matches
     * the user's UID from the path, ensuring relational integrity for subcollections.
     */
    function incomingSubcollectionDataMatchesUser(userId) {
      return request.resource.data.userId == userId;
    }
    
    /**
     * On create, validates that the incoming RenewalRequest's 'userId' field matches
     * the authenticated user's UID.
     */
    function isRequestOwner() {
        return request.resource.data.userId == request.auth.uid;
    }
    
    function isBuyer() {
      return request.resource.data.buyerId == request.auth.uid;
    }
    
    function isWithdrawalRequestOwner() {
      return request.resource.data.ownerId == request.auth.uid;
    }


    // -------------------------------------------------------------------------
    // Collection Rules
    // -------------------------------------------------------------------------
    
     /**
     * @description Manages Al-Wadi renewal options. Anyone can read, but only
     * admins can write (create, update, delete).
     */
    match /alwadiOptions/{optionId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    /**
     * @description Manages the promotional advertisement. Anyone can read, but
     * only admins can write (create, update, delete).
     */
    match /advertisements/{adId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    /**
     * @description Manages global notifications. Anyone can read, but only
     * admins can write (create). Updates and deletes are disallowed for all.
     */
    match /notifications/{notificationId} {
        allow read: if isSignedIn();
        allow create, delete: if isAdmin();
        allow update: if false; // Notifications are immutable
    }
    
    /**
     * @description Manages subscription renewal requests. Authenticated users can
     * create their own requests. Admins can read all requests and update their status.
     */
    match /renewalRequests/{requestId} {
      allow create: if isSignedIn() && isRequestOwner();
      allow read, update, delete: if isAdmin();
    }

    /**
     * @description Manages withdrawal requests from network owners.
     */
    match /withdrawalRequests/{requestId} {
      allow create: if isSignedIn() && isWithdrawalRequestOwner();
      allow read, update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    /**
     * @description Manages available payment methods. Any authenticated user can read
     * them (including server-side functions), but only admins can modify them.
     */
    match /paymentMethods/{methodId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    /**
     * @description Manages global application settings.
     */
    match /appSettings/{settingsId} {
        allow read: if true;
        allow write: if isAdmin();
    }
    
    /**
     * @description Stores records of sold cards for reporting.
     */
    match /soldCards/{cardId} {
      allow create: if isSignedIn() && isBuyer();
      allow get: if isAdmin() || isBuyer();
      allow update, delete: if false;
    }
    
    match /soldCards {
        allow list: if isAdmin();
    }
    
    /**
     * @description Stores records of automated deposits to prevent duplicates.
     */
    match /depositRequests/{requestId} {
      allow read, write: if isSignedIn();
    }
    
    match /depositRequests {
      allow list: if isSignedIn();
    }


    /**
     * @description Manages user profile documents.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      // Allow user to update their own data, and allow any signed-in (server) process.
      allow update: if isOwner(userId) || isSignedIn();
      allow delete: if isAdmin();

      /**
       * @description Manages a user's private transaction history.
       */
      match /transactions/{transactionId} {
        // Any signed-in user/process can create a transaction for another user
        // (e.g., server deposits, user transfers).
        allow create: if isSignedIn();
        allow read: if isOwner(userId);
        allow update, delete: if isOwner(userId);
      }

      /**
       * @description Manages a user's private list of favorites.
       */
      match /favorites/{favoriteId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && incomingSubcollectionDataMatchesUser(userId);
        allow update, delete: if isOwner(userId);
      }
      
      /**
       * @description Manages personal notifications for a user.
       */
      match /notifications/{notificationId} {
          allow read: if isOwner(userId);
          // Admins or any signed-in process (like the server) can create notifications.
          allow create: if isAdmin() || isSignedIn();
          allow delete: if isOwner(userId);
          allow update: if false;
      }
    }
    
    /**
     * @description Manages WiFi network information.
     */
    match /networks/{networkId} {
      allow read: if isSignedIn();
      allow create: if isAdmin() || request.resource.data.ownerId == request.auth.uid;
      allow update: if isAdmin() || isNetworkOwner(networkId);
      allow delete: if isAdmin() || isNetworkOwner(networkId);

      /**
       * @description Manages card categories for a network.
       */
      match /cardCategories/{categoryId} {
        allow read: if isSignedIn() || isAdmin();
        allow write: if isAdmin() || isNetworkOwner(networkId);
      }

      /**
       * @description Manages individual WiFi cards.
       */
      match /cards/{cardId} {
        allow read: if isSignedIn() || isAdmin();
        allow create, delete: if isAdmin() || isNetworkOwner(networkId);
        // Allow user to purchase a card.
        allow update: if (isAdmin() || isNetworkOwner(networkId)) || (isSignedIn() 
            && request.resource.data.status == 'sold'
            && resource.data.status == 'available'
            && request.resource.data.soldTo == request.auth.uid);
      }
    }
  }
}
